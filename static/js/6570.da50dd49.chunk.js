"use strict";(self.webpackChunktyphoon=self.webpackChunktyphoon||[]).push([[6570,2945],{26570:(e,t,i)=>{i.r(t),i.d(t,{default:()=>k});var s=i(35143),a=i(94643),r=i(50076),n=i(76460),o=i(87663),l=i(77717),d=i(50346),p=i(90534),u=i(49723),h=i(46053),c=(i(81806),i(47249),i(28379)),y=i(85842),f=i(17707),g=i(49140),m=i(25515),v=i(68705),_=i(83716),w=i(52451),M=i(19502),b=i(65624),T=i(31362),I=i(11270),A=i(94729),S=i(21617),E=i(5682),P=i(95363),L=i(14476),D=i(79453);let R=class extends((0,b.dM)((0,E.j)((0,S.J)((0,M.b)((0,I.q)((0,A.A)((0,l.P)((0,T.d)(m.A))))))))){constructor(e){super(e),this._graphTypeLookup=new Map,this._namedTypesModified=!1,this.dataManager=null,this.definitionSetMap=null,this.knowledgeGraph=null,this.layers=new(a.A.ofType(_.A)),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="KnowledgeGraphLayer",this.sublayerIdsCache=new Map,this.tables=new(a.A.ofType(_.A)),this.type="knowledge-graph",this.url=null}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){try{await this.loadFromPortal({supportedTypes:["Knowledge Graph Layer"]},e)}catch(t){(0,d.QP)(t)}await this._fetchMetadata(),await this._initializeLayerProperties(),this.loadLayerAssumingLocalCache()}async _fetchMetadata(){if(!this.url)throw new r.A("knowledge-graph:missing-url","KnowledgeGraphLayer must be created with a url");const e=await(0,L.fetchKnowledgeGraph)(this.url);this.knowledgeGraph=e,this._forEachGraphType((e=>{e.name&&this._graphTypeLookup.set(e.name,e)}))}async _initializeLayerProperties(){this.originIdOf("inclusionModeDefinition")===g.Gr.USER?this._validateInclusionModeDefinition():await this._initializeInclusionModeDefinition(),this._setMemberTypes(),this.dataManager=new v.PB({knowledgeGraph:this.knowledgeGraph,inclusionModeDefinition:this.inclusionModeDefinition})}async _initializeInclusionModeDefinition(){const e=this.definitionSetMap?await(0,w._s)(this.definitionSetMap,!0):{generateAllSublayers:!0,namedTypeDefinitions:new Map};[...this.layers.toArray(),...this.tables.toArray()].forEach((t=>{const i=this._graphTypeLookup.get(t.graphTypeName);i&&!e.namedTypeDefinitions.has(i.name)&&e.namedTypeDefinitions.set(i.name,{useAllData:!0})})),this.setAtOrigin("inclusionModeDefinition",e,(0,g.OL)(this.originIdOf("definitionSetMap")))}_validateInclusionModeDefinition(){const{inclusionModeDefinition:e}=this;if(!e)return;const{namedTypeDefinitions:t}=e;if((null===t||void 0===t?void 0:t.size)>0)t.forEach(((e,i)=>{const s=this._graphTypeLookup.get(i);if(!s)return n.A.getLogger(this).warn("A named type, ".concat(i,", was in the inclusion list that wasn't in the data model and will be removed")),void t.delete(i);"relationship"!==s.type&&"entity"!==s.type&&(n.A.getLogger(this).warn("A named type, ".concat(i,", was in the inclusion list that wasn't properly modeled and will be removed")),t.delete(i))}));else if(!e.generateAllSublayers)throw new r.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined")}_setMemberTypes(){var e,t,i,s;let a=[],r=[];const{inclusionModeDefinition:n}=this,o=null===n||void 0===n?void 0:n.namedTypeDefinitions;!n||n.generateAllSublayers?(a=null!==(e=null===(t=this.knowledgeGraph.dataModel)||void 0===t?void 0:t.entityTypes)&&void 0!==e?e:[],r=null!==(i=null===(s=this.knowledgeGraph.dataModel)||void 0===s?void 0:s.relationshipTypes)&&void 0!==i?i:[]):o&&o.size>0&&o.forEach(((e,t)=>{const i=this._graphTypeLookup.get(t);switch(null===i||void 0===i?void 0:i.type){case"relationship":r.push(i);break;case"entity":a.push(i)}})),this.memberEntityTypes=a,this.memberRelationshipTypes=r}_forEachGraphType(e){var t,i,s,a;[...null!==(t=null===(i=this.knowledgeGraph.dataModel)||void 0===i?void 0:i.entityTypes)&&void 0!==t?t:[],...null!==(s=null===(a=this.knowledgeGraph.dataModel)||void 0===a?void 0:a.relationshipTypes)&&void 0!==s?s:[]].forEach((t=>{e(t)}))}_refreshNamedTypes(){this._namedTypesModified=!0;for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const i of e)this.sublayerIdsCache.has(i.typeName)||(this.sublayerIdsCache.set(i.typeName,new Set),t.push(i.typeName)),this.sublayerIdsCache.get(i.typeName).add(i.id);for(const i of t){const e=this._graphTypeLookup.get(i);e&&(this._addSublayer(e).title=i,"entity"===e.type?this.dataManager.entityTypeNames.add(i):this.dataManager.relationshipTypeNames.add(i),this.dataManager.sublayerCaches.set(i,new Map))}this._refreshNamedTypes()}_createSublayers(e,t,i){e.forEach((e=>{const s=this._createSublayer(e);i(s)&&t.push(s),this._updateSublayerCaches(e)}))}_addSublayer(e){const t=this._createSublayer(e);return t.geometryType?this.layers.push(t):this.tables.push(t),t}_createSublayer(e){return new _.A({objectType:e,parentCompositeLayer:this,graphType:e.type,title:e.name})}_updateSublayers(e,t){t.forEach((t=>{t.parentCompositeLayer=this;const i=e.find((e=>e.type===t.graphType&&e.name===t.graphTypeName));i&&(t.objectType=i,t.read({title:i.name},{origin:"service"}),this._updateSublayerCaches(i))}))}_updateSublayerCaches(e){const t=this.dataManager.sublayerCaches;t.has(e.name)||t.set(e.name,new Map)}_saveUrlAsNewResource(e,t,i,s){e[t]="<pending>",i.pendingOperations.push(async function(e){const t=await(0,w.fe)(e);return new Blob([t],{type:"application/x-protobuf"})}(this.inclusionModeDefinition).then((a=>{const r=function(e){const t="definitionSetMap-".concat((0,u.lk)(),".dat"),i=(0,p.fj)("knowledgeGraphLayer",t);return e.resourceFromPath(i)}(s);e[t]=r.itemRelativeUrl,i.toAdd.push({resource:r,content:{type:"blob",blob:a},compress:!1,finish:e=>{this.definitionSetMap=e.url}})})))}_displaysAllRecords(e){for(const[,{useAllData:t}]of e.namedTypeDefinitions)if(!t)return!1;return!0}readDefinitionSetMap(e,t,i){return(0,D.f)(e,i)}writeDefinitionSetMap(e,t,i,s){const a=null===s||void 0===s?void 0:s.portalItem,r=null===s||void 0===s?void 0:s.resources,n=(0,g.aB)(null===s||void 0===s?void 0:s.origin);if(!a||!r||null==n)return void(e&&(t[i]=(0,D.t)(e,s)));const{inclusionModeDefinition:o}=this;if(!o||this._displaysAllRecords(o))return void(this.definitionSetMap=null);const l=this.originIdOf("inclusionModeDefinition");if(l===g.Gr.USER||this._namedTypesModified||n<l)this._saveUrlAsNewResource(t,i,r,a);else if(n===l&&e){const n=(0,D.t)(e,s);(0,p.oP)(n)?this._saveUrlAsNewResource(t,i,r,a):t[i]=n}}set inclusionModeDefinition(e){"loaded"!==this.loadStatus&&"failed"!==this.loadStatus?this._set("inclusionModeDefinition",e):n.A.getLogger(this).error("#inclusionModeDefinition","inclusionModeDefinition cannot be changed after the layer is loaded.")}loadLayerAssumingLocalCache(){var e;const t=[...this.memberEntityTypes,...this.memberRelationshipTypes];this.originIdOf("layers")===g.Gr.DEFAULTS?this._createSublayers(t,this.layers,(e=>!!e.geometryType)):this._updateSublayers(t,this.layers),this.originIdOf("tables")===g.Gr.DEFAULTS?this._createSublayers(t,this.tables,(e=>!e.geometryType)):this._updateSublayers(t,this.tables),null===(e=this.dataManager.inclusionModeDefinition)||void 0===e||null===(e=e.namedTypeDefinitions)||void 0===e||e.forEach(((e,t)=>{var i;const s=(0,o.tE)(this.sublayerIdsCache,t,(()=>new Set));null===(i=e.members)||void 0===i||i.forEach((e=>{s.add(e.id)}))}))}async addRecords(e){await this._handleNewRecords(e)}async removeRecords(e){const t=[];for(const r of e){var i,s;!1===(null===(i=this.dataManager.inclusionModeDefinition)||void 0===i||null===(i=i.namedTypeDefinitions)||void 0===i||null===(i=i.get(r.typeName))||void 0===i?void 0:i.useAllData)&&(null===(s=this.dataManager.inclusionModeDefinition)||void 0===s||null===(s=s.namedTypeDefinitions)||void 0===s||null===(s=s.get(r.typeName))||void 0===s||null===(s=s.members)||void 0===s?void 0:s.has(r.id))&&t.push(r)}this.dataManager.removeFromLayer(t);for(const r of t){var a;null===(a=this.sublayerIdsCache.get(r.typeName))||void 0===a||a.delete(r.id)}return this._refreshNamedTypes(),t}};(0,s._)([(0,h.MZ)()],R.prototype,"dataManager",void 0),(0,s._)([(0,h.MZ)({json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],R.prototype,"definitionSetMap",void 0),(0,s._)([(0,c.w)("definitionSetMap")],R.prototype,"readDefinitionSetMap",null),(0,s._)([(0,f.K)("definitionSetMap")],R.prototype,"writeDefinitionSetMap",null),(0,s._)([(0,h.MZ)()],R.prototype,"inclusionModeDefinition",null),(0,s._)([(0,h.MZ)()],R.prototype,"knowledgeGraph",void 0),(0,s._)([(0,h.MZ)({type:a.A.ofType(_.A),json:{write:{ignoreOrigin:!0}}})],R.prototype,"layers",void 0),(0,s._)([(0,h.MZ)()],R.prototype,"memberEntityTypes",void 0),(0,s._)([(0,h.MZ)()],R.prototype,"memberRelationshipTypes",void 0),(0,s._)([(0,h.MZ)({type:["KnowledgeGraphLayer"]})],R.prototype,"operationalLayerType",void 0),(0,s._)([(0,h.MZ)()],R.prototype,"sublayerIdsCache",void 0),(0,s._)([(0,h.MZ)({type:a.A.ofType(_.A),json:{write:{ignoreOrigin:!0}}})],R.prototype,"tables",void 0),(0,s._)([(0,h.MZ)({json:{read:!1}})],R.prototype,"type",void 0),(0,s._)([(0,h.MZ)(P.OZ)],R.prototype,"url",void 0),R=(0,s._)([(0,y.$)("esri.layers.KnowledgeGraphLayer")],R);const k=R},19502:(e,t,i)=>{i.d(t,{b:()=>l});var s=i(35143),a=i(76460),r=i(46053),n=(i(81806),i(47249),i(85842)),o=i(13096);const l=e=>{let t=class extends e{get title(){if(this._get("title")&&"defaults"!==this.originOf("title"))return this._get("title");if(this.url){const e=(0,o.qg)(this.url);if(null!=e&&e.title)return e.title}return this._get("title")||""}set title(e){this._set("title",e)}set url(e){this._set("url",(0,o.Jf)(e,a.A.getLogger(this)))}};return(0,s._)([(0,r.MZ)()],t.prototype,"title",null),(0,s._)([(0,r.MZ)({type:String})],t.prototype,"url",null),t=(0,s._)([(0,n.$)("esri.layers.mixins.ArcGISService")],t),t}},31362:(e,t,i)=>{i.d(t,{d:()=>n});var s=i(35143),a=i(46053),r=(i(81806),i(76460),i(47249),i(85842));const n=e=>{let t=class extends e{constructor(){super(...arguments),this.customParameters=null}};return(0,s._)([(0,a.MZ)({type:Object,json:{write:{overridePolicy:e=>({enabled:!!(e&&Object.keys(e).length>0)})}}})],t.prototype,"customParameters",void 0),t=(0,s._)([(0,r.$)("esri.layers.mixins.CustomParametersMixin")],t),t}},94729:(e,t,i)=>{i.d(t,{A:()=>b});var s=i(35143),a=i(86560),r=i(55171),n=i(3825),o=i(98773),l=i(50076),d=i(76460),p=i(30726),u=i(50346),h=i(90534),c=i(46053),y=(i(81806),i(47249),i(28379)),f=i(85842),g=i(17707),m=i(31933),v=i(65308),_=i(70652),w=i(38665),M=i(72945);const b=e=>{let t=class extends e{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1}destroy(){this.portalItem=(0,p.pR)(this.portalItem),this.resourceReferences.portalItem=null,this.resourceReferences.paths.length=0}set portalItem(e){e!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",e))}readPortalItem(e,t,i){if(t.itemId)return new _.default({id:t.itemId,portal:null===i||void 0===i?void 0:i.portal})}writePortalItem(e,t){(null===e||void 0===e?void 0:e.id)&&(t.itemId=e.id)}async loadFromPortal(e,t){var s;if(null!==(s=this.portalItem)&&void 0!==s&&s.id)try{const{load:s}=await Promise.all([i.e(2487),i.e(3814)]).then(i.bind(i,73814));return(0,u.Te)(t),await s({instance:this,supportedTypes:e.supportedTypes,validateItem:e.validateItem,supportsData:e.supportsData,layerModuleTypeMap:e.layerModuleTypeMap},t)}catch(a){throw(0,u.zf)(a)||d.A.getLogger(this).warn("Failed to load layer (".concat(this.title,", ").concat(this.id,") portal item (").concat(this.portalItem.id,")\n  ").concat(a)),a}}async finishLoadEditablePortalLayer(e){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(e).catch((e=>((0,u.QP)(e),!0))))}async setUserPrivileges(e,t){if(!a.A.userPrivilegesApplied)return this.finishLoadEditablePortalLayer(t);if(this.url)try{const{features:{edit:i,fullEdit:s},content:{updateItem:a}}=await this._fetchUserPrivileges(e,t);this._set("userHasEditingPrivileges",i),this._set("userHasFullEditingPrivileges",s),this._set("userHasUpdateItemPrivileges",a)}catch(i){(0,u.QP)(i)}}async _fetchUserPrivileges(e,t){let i=this.portalItem;if(!e||!i||!i.loaded||i.sourceUrl)return this._fetchFallbackUserPrivileges(t);const s=e===i.id;if(s&&i.portal.user)return(0,M.It)(i);let a,n;if(s)a=i.portal.url;else try{a=await(0,m.wI)(this.url,t)}catch(p){(0,u.QP)(p)}if(!a||!(0,h.b8)(a,i.portal.url))return this._fetchFallbackUserPrivileges(t);try{const e=null!=t?t.signal:null;n=await(null===r.id||void 0===r.id?void 0:r.id.getCredential("".concat(a,"/sharing"),{prompt:!1,signal:e}))}catch(p){(0,u.QP)(p)}const o=!0,l=!1,d=!1;if(!n)return{features:{edit:o,fullEdit:l},content:{updateItem:d}};try{if(s?await i.reload():(i=new _.default({id:e,portal:{url:a}}),await i.load(t)),i.portal.user)return(0,M.It)(i)}catch(p){(0,u.QP)(p)}return{features:{edit:o,fullEdit:l},content:{updateItem:d}}}async _fetchFallbackUserPrivileges(e){let t=!0;try{t=await this._fetchUserHasEditingPrivileges(e)}catch(i){(0,u.QP)(i)}return{features:{edit:t,fullEdit:!1},content:{updateItem:!1}}}async _fetchUserHasEditingPrivileges(e){const t=this.url?null===r.id||void 0===r.id?void 0:r.id.findCredential(this.url):null;if(!t)return!0;const i=T.credential===t?T.user:await this._fetchEditingUser(e);return T.credential=t,T.user=i,null==(null===i||void 0===i?void 0:i.privileges)||i.privileges.includes("features:user:edit")}async _fetchEditingUser(e){var t,i;const s=null===(t=this.portalItem)||void 0===t||null===(t=t.portal)||void 0===t?void 0:t.user;if(s)return s;const a=null===r.id||void 0===r.id?void 0:r.id.findServerInfo(null!==(i=this.url)&&void 0!==i?i:"");if(null===a||void 0===a||!a.owningSystemUrl)return null;const l="".concat(a.owningSystemUrl,"/sharing/rest"),d=v.A.getDefault();if(d&&d.loaded&&(0,h.S8)(d.restUrl)===(0,h.S8)(l))return d.user;const p="".concat(l,"/community/self"),u=null!=e?e.signal:null,c=await(0,o.Ke)((0,n.A)(p,{authMode:"no-prompt",query:{f:"json"},signal:u}));return c.ok?w.A.fromJSON(c.value.data):null}read(e,t){t&&(t.layer=this),super.read(e,t)}write(e,t){var i;const s=null===t||void 0===t?void 0:t.portal,a=(null===(i=this.portalItem)||void 0===i?void 0:i.id)&&(this.portalItem.portal||v.A.getDefault());return s&&a&&!(0,h.ut)(a.restUrl,s.restUrl)?(t.messages&&t.messages.push(new l.A("layer:cross-portal","The layer '".concat(this.title," (").concat(this.id,")' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer"),{layer:this})),null):super.write(e,{...t,layer:this})}};return(0,s._)([(0,c.MZ)({type:_.default})],t.prototype,"portalItem",null),(0,s._)([(0,y.w)("web-document","portalItem",["itemId"])],t.prototype,"readPortalItem",null),(0,s._)([(0,g.K)("web-document","portalItem",{itemId:{type:String}})],t.prototype,"writePortalItem",null),(0,s._)([(0,c.MZ)({clonable:!1})],t.prototype,"resourceReferences",void 0),(0,s._)([(0,c.MZ)({type:Boolean,readOnly:!0})],t.prototype,"userHasEditingPrivileges",void 0),(0,s._)([(0,c.MZ)({type:Boolean,readOnly:!0})],t.prototype,"userHasFullEditingPrivileges",void 0),(0,s._)([(0,c.MZ)({type:Boolean,readOnly:!0})],t.prototype,"userHasUpdateItemPrivileges",void 0),t=(0,s._)([(0,f.$)("esri.layers.mixins.PortalLayer")],t),t},T={credential:null,user:null}},72945:(e,t,i)=>{i.d(t,{It:()=>h,LG:()=>n,OM:()=>d,Y:()=>o,bK:()=>l,mm:()=>u,sQ:()=>p});var s=i(26346),a=i(13312),r=i(45417);function n(e,t){if(!o(e,t)){const i=e.typeKeywords;i?i.push(t):e.typeKeywords=[t]}}function o(e,t){var i;return!(null===(i=e.typeKeywords)||void 0===i||!i.includes(t))}function l(e){return o(e,u.HOSTED_SERVICE)}function d(e,t){const i=e.typeKeywords;if(i){const e=i.indexOf(t);e>-1&&i.splice(e,1)}}async function p(e){const t=e.clone().normalize();let i;if(t.length>1)for(const s of t)i?s.width>i.width&&(i=s):i=s;else i=t[0];return async function(e){const t=e.spatialReference;if(t.isWGS84)return e.clone();if(t.isWebMercator)return(0,r.ci)(e);const i=a.A.WGS84;return await(0,s.initializeProjection)(t,i),(0,s.project)(e,i)}(i)}const u={DEVELOPER_BASEMAP:"DeveloperBasemap",JSAPI:"ArcGIS API for JavaScript",METADATA:"Metadata",MULTI_LAYER:"Multilayer",SINGLE_LAYER:"Singlelayer",TABLE:"Table",HOSTED_SERVICE:"Hosted Service",LOCAL_SCENE:"ViewingMode-Local",TILED_IMAGERY:"Tiled Imagery",GROUP_LAYER_MAP:"Map"};function h(e){var t;const{portal:i,isOrgItem:s,itemControl:a}=e,r=null===(t=i.user)||void 0===t?void 0:t.privileges;let n=!r||r.includes("features:user:edit"),o=!!s&&!(null===r||void 0===r||!r.includes("features:user:fullEdit"));const l="update"===a||"admin"===a;return l?o=n=!0:o&&(n=!0),{features:{edit:n,fullEdit:o},content:{updateItem:l}}}}}]);
//# sourceMappingURL=6570.da50dd49.chunk.js.map